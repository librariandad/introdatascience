---
title: "Project Notebook"
author: "Keith Engwall"
date: "1/23/2018"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Project Objectives
Create a predictive model for identifying patients with Diabetes

See [Capstone Proposal](https://github.com/librariandad/introdatascience/blob/master/capstone_proposal.Rmd) for details.

## Project Questions

Does there tend to be a difference in age between diabetic patients and non-diabetic patients?

Is either gender more prone to diabetes?

Are there allergy types that correlate with diabetes?

Are there diagnosis categories that correlate with diabetes?

Are there medications that correlate with diabetes?

Are there characteristics (weight, blood pressure, lab results) that are significantly different in the diabetic population than in non-diabetics?

Is there any correlation between diabetes and smoking?


## Project Dataset
Practice Fusion De-Identified Data Set containing EHR data for approximately 10,000 de-identified patients, including data points for diagnoses, medication, transcript data, and lab observations.  See the [Data Dictionary](https://github.com/librariandad/introdatascience/blob/master/PracticeFusionDataSetDictionary.pdf) for details.


## Project Notes

### Load R Packages
The following packages are needed to work on the project.

Note that dbplyr is required to make database connections using dplyr functions.
```{r message = FALSE, warning = FALSE}
library(tidyr)
library(dplyr)
library(dbplyr)
library(readr)
library(ggplot2)
library(Hmisc)
```

### Load Data from csv files

Read the data files into R.  Use select statements to pre-filter the desired columns.

```{r message = FALSE, warning = FALSE}

# read patient table into data frame.
patient <- read_csv("db/training_patient.csv") %>%
  select(-PracticeGuid)

# read diagnosis table into data frame.  
diagnosis <- read_csv("db/training_diagnosis.csv") %>%
  select(DiagnosisGuid, DiagnosisDescription, PatientGuid, ICD9Code, StartYear, StopYear, Acute)

# read allergy table into data frame. Change column name of MedicationNdcCode to AllergyMedicationNdcCode to diambiguate between medication allergies and prescriptions.
allergy <- read_csv("db/training_allergy.csv") %>%
  select(AllergyGuid, PatientGuid, AllergyType, AllergyStartYear = StartYear, ReactionName, SeverityName, AllergyMedicationNdcCode = MedicationNdcCode)

# read prescription table into data frame.
prescription <- read_csv("db/training_prescription.csv") %>%
  select(PrescriptionGuid, PatientGuid, MedicationGuid, PrescriptionYear, Quantity, GenericAllowed)

# read medication table into data frame.
medication <- read_csv("db/training_medication.csv") %>%
  select(MedicationGuid, PatientGuid, MedicationNdcCode, MedicationName, MedicationStrength, Schedule, DiagnosisGuid)

# read immunization table into data frame.
immunization <- read_csv("db/training_immunization.csv") %>%
  select(ImmunizationGuid, PatientGuid, VaccineName, AdministeredYear, CvxCode)

# read lab tables into data frames.
labResult <- read_csv("db/training_labResult.csv") %>%
  select(LabResultGuid,PatientGuid, TranscriptGuid)

labPanel <- read_csv("db/training_labPanel.csv") %>%
  select(LabResultGuid, LabPanelGuid, PanelName)

labObservation <- read_csv("db/training_labObservation.csv")


# read transcript table into data frame.
transcript <- read_csv("db/training_transcript.csv") %>%
  select(TranscriptGuid, PatientGuid, VisitYear, Height, Weight, BMI, SystolicBP, DiastolicBP, RespiratoryRate, HeartRate, Temperature)

# read smoke table into data frame.
smoke <- read_csv("db/training_smoke.csv") %>%
  select(PatientGuid, SmokeEffectiveYear, SmokingStatus_Description, SmokingStatus_NISTCode)

#read join tables into data frames.
transDiag <- read_csv("db/training_transcriptDiagnosis.csv")
transMed <- read_csv("db/training_transcriptMedication.csv")
transAllergy <- read_csv("db/training_transcriptAllergy.csv")
```
### Data Cleaning
To prepare the data for analysis, add columns and make other modifications to the data.

```{r warning=FALSE, messsage=FALSE}
# add age column to patient data frame: derived from subtracting 2010, the median year of the patient data (range: 2009 - 2012)
patient <- patient %>% mutate(age = 2010 - YearOfBirth)

# add daibetesStatus column to patient data frame for display in graphs.
patient$diabetesStatus <- ifelse(patient$dmIndicator, "Diabetic", "NonDiabetic")

# change type of AllergyMedicationNdcCode column to character.
allergy <- transform(allergy, AllergyMedicationNdcCode = as.character(AllergyMedicationNdcCode))

# change transcript Height & Weight to numeric types
transcript <- transform(transcript, Height = as.numeric(Height), Weight = as.numeric(Weight), Temperature = as.numeric(Temperature), RespiratoryRate = as.numeric(RespiratoryRate), HeartRate = as.numeric(HeartRate), SystolicBP = as.numeric(SystolicBP), DiastolicBP = as.numeric(DiastolicBP))
  
# add pulsePressure column to transcript (SystolicBP - DiastolicBP)
transcript <- transcript %>%
  filter(!is.na(SystolicBP)) %>% filter(!is.na(DiastolicBP)) %>% filter(SystolicBP > 0 & DiastolicBP > 0) %>%
  mutate(pulsePressure = SystolicBP - DiastolicBP)


```


For diagnoses, rather than identify each individual diagnosis type, we can
create categories of diagnoses based on the ICD9 codes

```{r message = FALSE, warning = FALSE}

# create diagCat column in patientDiagnosis containing diagnosis categories corresponding to ranges of ICD9 Codes
diagnosis$diagCat <-
  ifelse((as.integer(diagnosis$ICD9Code) < 140), 
    "Infectious/Parasitic",
    ifelse((as.integer(diagnosis$ICD9Code) >= 140 &
      as.integer(diagnosis$ICD9Code) < 240), 
      "Neoplasms",
      ifelse((as.integer(diagnosis$ICD9Code) >=240 &
        as.integer(diagnosis$ICD9Code) < 280),
          "Endocrine/Nutritional/Metabolic",
          ifelse((as.integer(diagnosis$ICD9Code) >= 280 &
            as.integer(diagnosis$ICD9Code) < 290),
            "Blood",
            ifelse((as.integer(diagnosis$ICD9Code) >= 290 &
              as.integer(diagnosis$ICD9Code) < 320),
              "Mental",
              ifelse((as.integer(diagnosis$ICD9Code) >= 320 &
                as.integer(diagnosis$ICD9Code) < 390),
                "Nervous",
                ifelse((as.integer(diagnosis$ICD9Code) >= 390 &
                  as.integer(diagnosis$ICD9Code) < 460),
                  "Circulatory",
                  ifelse((as.integer(diagnosis$ICD9Code) >= 460 &
                    as.integer(diagnosis$ICD9Code) < 520),
                    "Respiratory",
                    ifelse((as.integer(diagnosis$ICD9Code) >= 520 &
                      as.integer(diagnosis$ICD9Code) < 580),
                      "Digestive",
  ifelse((as.integer(diagnosis$ICD9Code) >= 580 &
    as.integer(diagnosis$ICD9Code) < 630), 
    "Genitourinary",
    ifelse((as.integer(diagnosis$ICD9Code) >= 630 &
      as.integer(diagnosis$ICD9Code) < 680), 
      "Pregnancy",
      ifelse((as.integer(diagnosis$ICD9Code) >=680 &
        as.integer(diagnosis$ICD9Code) < 710),
          "Skin",
          ifelse((as.integer(diagnosis$ICD9Code) >=710 &
            as.integer(diagnosis$ICD9Code) < 740),
            "Musculoskeletal",
            ifelse((as.integer(diagnosis$ICD9Code) >= 740 &
              as.integer(diagnosis$ICD9Code) < 760),
              "Congenital",
              ifelse((as.integer(diagnosis$ICD9Code) >= 760 &
                as.integer(diagnosis$ICD9Code) < 780),
                "Perinatal",
                ifelse((as.integer(diagnosis$ICD9Code) >= 780 &
                  as.integer(diagnosis$ICD9Code) < 800),
                  "Ill Defined", 
                  ifelse((as.integer(diagnosis$ICD9Code) >= 800),
                    "Injury/Poisoning", 
                    "NULL"
                    )
                  )
                )
            )
          )
      )
    )
  ))))))))))
```

### Prepare data frames
```{r message = FALSE}
# prescription data frame
presMed <- left_join(prescription, medication)
presJoin <- left_join(presMed, transMed) %>% select(-TranscriptMedicationGuid)
presTran <- left_join(presJoin, transcript)

# diagnosis data frame
diagJoin <- left_join(diagnosis, transDiag) %>% select(-TranscriptDiagnosisGuid)
diagTran <- left_join(diagJoin, transcript)

# allergy data frame
allerJoin <- left_join(allergy, transAllergy) %>% select(-TranscriptAllergyGuid)
allerTran <- left_join(allerJoin, transcript)

# labs data frame
labs <- left_join(
  left_join(labResult, labPanel, by="LabResultGuid"),
  labObservation,
  by="LabPanelGuid"
)  

# smoking data frame
smoke <- smoke %>% mutate(TranscriptGuid = "SMOKE")
```

```{r}
# master data frame (comprised of all data frames)
dataJoin <- full_join(presJoin, diagJoin)
dataJoin2 <- full_join(dataJoin, allerJoin)
dataJoin3 <- full_join(dataJoin2, labs)
dataJoin4 <- full_join(dataJoin3, smoke)
dataMaster <- left_join(dataJoin4, transcript)
```

```{r}
# patient data frames (join patient table to each data frame)
patientPrescription <- left_join(patient, presTran)
patientDiagnosis <- left_join(patient, diagTran)
# patientAllergy <- inner_join(patient, allerTran)
patientAllergy <- inner_join(patient, allerTran)
# patientLabs <- inner_join(patient, labs)
patientLabs <- left_join(patient, labs)
patientSmoke <- left_join(patient, smoke)
patientMaster <- left_join(patient, dataMaster)
# patientTranscript <- inner_join(patient, transcript)
patientTranscript <- left_join(patient, transcript)

# diabetic data frames filter patient data frames based on dmIndicator == 1
diabeticBase <- patient %>% filter(dmIndicator == 1)
diabeticPrescription <- patientPrescription %>% filter(dmIndicator == 1)
diabeticDiagnosis <- patientDiagnosis %>% filter(dmIndicator == 1)
diabeticAllergy <- patientAllergy %>% filter(dmIndicator == 1)
diabeticLabs <- patientLabs %>% filter(dmIndicator == 1)
diabeticSmoke <- patientSmoke %>% filter(dmIndicator == 1)
diabeticMaster <- patientMaster %>% filter(dmIndicator == 1)
```

### Additional Data Cleaning
Due to the large amount of medication allergy data, we must filter the data down
to medications for which at least one diabetic patient has an allergy
and for which at least 20 patients have allergies

```{r message = FALSE, warning = FALSE}
# create medicationMap data frame linking medication names to their NDC Codes
medicationMap <- medication %>% select(MedicationNdcCode, MedicationName) %>% group_by(MedicationNdcCode) %>% distinct(MedicationName) %>% arrange(MedicationNdcCode)

# use inner join to filter patients to those 
# with medication allergies, and pull in the names for the medications
allergyMeds <- inner_join(patientAllergy,medicationMap, by = c("AllergyMedicationNdcCode" = "MedicationNdcCode"))

# identify the medications by name for which diabetic patients have allergies
diabeticMedNames <- allergyMeds %>% filter(dmIndicator == "1") %>% select(MedicationName) %>% distinct()

# use inner join to filter patients to those using the medications for which
# diabetic patients also have allergies (filter out all medication allergies
# for which diabetic patients do not have allergies)
diabeticAllergyMeds <- inner_join(allergyMeds,diabeticMedNames)

# identify the medications for which at least 20 patients have allergies
topAllergyNdcCodes <- diabeticAllergyMeds %>%
  group_by(AllergyMedicationNdcCode) %>% 
  summarise(n = n()) %>%
  ungroup() %>%
  filter(n >= 20) %>%
  select(AllergyMedicationNdcCode)

# use inner join to filter data to those medications for which at least 20 
# patients have allergies
diabeticAllergyMeds <- inner_join(allergyMeds,topAllergyNdcCodes)

# identify which medications are most used by diabetic patients in comparison to non-diabetic patients

# get a count of prescriptions for medications used by diabetic patients
diabeticMedicationList <- patientPrescription %>% filter(dmIndicator == 1) %>% group_by(MedicationName) %>% summarise(n = n()) %>% ungroup() %>% arrange(desc(n))

# join with a count of prescriptions for medications used by all patients
diabeticMedicationList <- inner_join(diabeticMedicationList, patientPrescription %>% group_by(MedicationName) %>% summarise(n = n()) %>% ungroup() %>% arrange(desc(n)), by="MedicationName")

# get the ratio between diabetic prescriptions and total prescriptions
diabeticMedicationList <- diabeticMedicationList %>%
  mutate(useRatio = n.x/n.y)

# had to tweak the filter to get a reasonably small set of the medications with the highest ratio of diabetic prescriptions with the highest number of overall prescriptions
topDiabeticMedicationList <- diabeticMedicationList %>% filter(n.y > 300 & useRatio > .6) %>% arrange(desc(useRatio))

# create a data frame limited to the top diabetic prescription list
topDiabeticPrescriptions <- inner_join(patientPrescription, topDiabeticMedicationList, by="MedicationName")

# sort the abnormal statuses in the labs data
patientLabs$AbnormalFlagsSorted = factor(patientLabs$AbnormalFlags, levels = rev(c("Panic Low", "Alert Low", "Below Normal Low", "NA", "Above Normal High", "Alert High", "Panic High", "Abnormal Result", "UKNOWN")))

```


```{r}
patientTranscript <- patientTranscript %>%
  filter(VisitYear > 2000) %>%
  mutate(patientAge = VisitYear - YearOfBirth)

patientTranscript %>% distinct(PatientGuid, .keep_all = TRUE) %>% group_by(patientAge)
patient %>% distinct(PatientGuid, .keep_all = TRUE) %>% group_by(age)
```
\pagebreak

### Data analysis

#### Age
It appears that the central tendency for Age is higher in the diabetic population than in the non-diabetic population

```{r}
#ggplot(patient, aes(x = diabetesStatus, y = age)) +
#  geom_boxplot()

boxplot(age~diabetesStatus,data=patient, outline = FALSE, main = "Patient Age", ylab = "Age (yr)", xlab = "Diabetes Status")

boxplot(patientAge~diabetesStatus, data=patientTranscript, outline = FALSE)
```

\pagebreak

#### Gender
The number of patients with diabetes is similar between males and females, but the ratio of males with diabetes is higher.

```{r}
ggplot(arrange(patient, rev(dmIndicator)), aes(x=Gender,fill=factor(diabetesStatus, levels = c("NonDiabetic","Diabetic")))) +
  geom_bar(position = "dodge") +
  labs(title = "Patient Gender", fill="Diabetes Status") +
  theme(plot.title = element_text(hjust = "0.5"))
```

\pagebreak

#### Allergies
Among non-medical allergy types, there appears to be a large proportion of diabetic patients with egg and peanut allergies in comparison to the general population.  The number of diabetic patients with egg allergies actually outnumbers non-diabetic patients.

```{r}

patientAllergy %>%
  filter(AllergyType != "Medication") %>%
  ggplot(aes(x=AllergyType, fill=factor(diabetesStatus, levels = c("NonDiabetic","Diabetic"))))+
  geom_bar(position="dodge") +
  labs(title = "Incidence of Allergies", fill = "Diabetes Status") +
  theme(axis.text.x = element_text(angle = 30, hjust = 1), plot.title = element_text(hjust = 0.5))

patientAllergy %>%
  filter(AllergyType == "Egg") %>%
  ggplot(aes(x=diabetesStatus, fill=factor(ReactionName)))+
  geom_bar(position="fill") +
  labs(title = "Egg Allergy Reactions", fill = "Diabetes Status") +
  theme(plot.title = element_text(hjust = 0.5))

patientAllergy %>%
  filter(AllergyType == "Peanut") %>%
  ggplot(aes(x=diabetesStatus, fill=factor(ReactionName)))+
  geom_bar(position="fill") +
  labs(title = "Severity of Peanut Allergy", fill = "Diabetes Status") +
  theme(plot.title = element_text(hjust = 0.5))

```

\pagebreak

Among the allergies to medicine, there appears to be an large proportion of diabetic patients with an allergy to Lisinopril compared to the general population.

```{r}
diabeticAllergyMeds %>%
  ggplot(aes(x=MedicationName, fill=factor(diabetesStatus, levels = c("NonDiabetic","Diabetic"))))+
  geom_bar(position="dodge") +
  labs(title="Incidence of Medication Allergies", fill = "Diabetes Status") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        plot.margin = margin(0,0,0,3.1,"cm"),
        plot.title = element_text(hjust = 0.5))
```

\pagebreak

### Weight, Height & BMI
Diabetic patients have a slightly higher weight than non-diabetic patients.

```{r}
#patientTranscript %>%
#  filter(Weight < 500 & Weight > 0) %>%
#  ggplot(aes(x=Weight,fill=diabetesStatus)) +
#  geom_histogram(binwidth=50, position="dodge")

boxplot(Weight~diabetesStatus, data=patientTranscript %>% filter(!is.na(Weight)) %>%filter(Weight < 600 & Weight > 0), outline = FALSE, main = "Weight", ylab = "Weight (lb)", xlab = "Diabetes Status")
```

\pagebreak

Diabetic patients have a slightly shorter height than non-diabetic patients.

```{r}
#heightData = patientTranscript %>% distinct(PatientGuid,.keep_all = TRUE)
boxplot(Height~diabetesStatus, data = patientTranscript %>% filter(!is.na(Height)) %>% filter(Height < 100 & Height > 10), outline=FALSE, main = "Height", ylab = "Height (in)", xlab = "Diabetes Status")
```

\pagebreak

Diabetic patients have a higher BMI than non-diabetic patients

```{r}
boxplot(BMI~diabetesStatus, data=patientTranscript %>% filter(!is.na(BMI)) %>% filter(BMI >0), outline=FALSE, main = "BMI", ylab = "BMI", xlab = "Diabetes Status")
```

\pagebreak

### Temperature
There is no significant difference in temperature between diabetic and non-diabetic patients.

```{r}
boxplot(Temperature~diabetesStatus, data=patientTranscript %>% filter(!is.na(Temperature)), outline = FALSE, main = "Temperature", ylab = "Temperature (deg F)", xlab = "Diabetes Status")
```

\pagebreak

### Respiratory Rate
There is no significant difference in respiratory rate between diabetic and non-diabetic patients.

```{r} 
boxplot(RespiratoryRate~diabetesStatus, data=patientTranscript %>% filter(!is.na(RespiratoryRate)), outline = FALSE, main = "Respiratory Rate", ylab = "Respiratory Rate (bpm)", xlab = "Diabetes Status")
```

\pagebreak

### Systolic BP, Diastolic BP, and Pulse Pressure
Systolic BP is higher for diabetic patients than non-diabetic patients.

```{r}
boxplot(as.integer(SystolicBP)~diabetesStatus, data=patientTranscript %>% filter(!is.na(SystolicBP)) %>% filter(SystolicBP > 0), outline=FALSE, main = "Systolic BP", ylab = "Systolic BP (mmHg)", xlab = "Diabetes Status")
```

\pagebreak

Diastolic BP is slightly lower for diabetic patients than non-diabetic patients.

```{r}
boxplot(as.integer(DiastolicBP)~diabetesStatus, data=patientTranscript %>% filter(!is.na(DiastolicBP)) %>% filter(DiastolicBP > 0), outline=FALSE, main = "Diastolic BP", ylab = "Diastolic BP (mmHg)", xlab = "Diabetes Status")
```

\pagebreak

The pulse pressure of diabetic patients is slightly higher than non-diabetic patients.

```{r}
boxplot(as.integer(pulsePressure)~diabetesStatus, data=patientTranscript %>% filter(pulsePressure != "NULL"), outline=FALSE, main = "Pulse Pressure", ylab = "Pulse Pressure (mmHg)", xlab = "Diabetes Status")
```

\pagebreak

### Diagnosis Categories
The diagnosis categories with the highest ratio between diabetic and non-diabetic patients are Circulatory and Endocrine/Nutritional/Metabolic.

```{r}
patientDiagnosis %>%
  filter(diagCat != "NULL") %>%
  filter(Acute == 1) %>%
  ggplot(aes(x=diagCat, fill=factor(diabetesStatus, levels = c("NonDiabetic","Diabetic"))))+
  geom_bar(position="dodge") +
  labs(title="Comorbidities", fill = "Diabetes Status") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        plot.title = element_text(hjust = 0.5))
#  labs(fill = "Diabetes Status") +
#  theme(axis.text.x = element_text(angle = 30, hjust = 1))

patientDiagnosis %>%
  filter(diagCat == "Circulatory") %>%
  filter(as.integer(ICD9Code) < 430) %>%
  ggplot(aes(x=factor(as.integer(ICD9Code)), fill=factor(diabetesStatus, levels = c("NonDiabetic","Diabetic"))))+
  geom_bar(position="dodge") +
  labs(title="Circulatory Comorbidities", fill = "Diabetes Status") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        plot.title = element_text(hjust = 0.5))

patientDiagnosis %>%
  filter(diagCat == "Circulatory") %>%
  filter(as.integer(ICD9Code) < 430) %>%
  filter(Acute == 1) %>%
  ggplot(aes(x=factor(as.integer(ICD9Code)), fill=factor(diabetesStatus, levels = c("NonDiabetic","Diabetic"))))+
  geom_bar(position="dodge") +
  labs(title="Acute Circulatory Comorbidities", fill = "Diabetes Status", x = "ICD9 Codes") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        plot.title = element_text(hjust = 0.5))

patientDiagnosis %>%
  filter(diagCat == "Circulatory") %>%
  filter(dmIndicator == 1) %>%
  group_by(ICD9Code) %>%
  summarise(n = n()) %>%
  ungroup() %>%
  arrange(desc(n))
```

\pagebreak

### Abnormal Labs
The lab results were limited to those for which there were sufficient abnormal readings data for the diabetic population.  For each lab result, an overall measure of central tendency was analyzed, as well as an analysis of abnormal lab result status.

```{r}
patientLabs %>% filter(dmIndicator == 1) %>% filter(IsAbnormalValue == 1) %>% group_by(HL7Text) %>% summarise(n = n()) %>% ungroup() %>% arrange(desc(n))
```

\pagebreak

#### Hemoglobin Lab Results
Hemoglobin levels have a lower central tendency in diabetic patients than in non-diabetic patients.  When results recorded as abnormal are separated out, the diabetic population has a larger percentage of below normal readings.  The central tendency of above normal readings were higher and of below normal readings were lower among the diabetic population.  The central tendency of normal readings was slightly lower in the diabetic population.

```{r}
boxplot(ObservationValue~diabetesStatus, data=patientLabs %>% filter(HL7Text == "Hemoglobin"), outline=FALSE, main = "Hemoglobin", ylab = "Hemoglobin (g/dL)", xlab = "Diabetes Status")


patientLabs %>%
  filter(HL7Text == "Hemoglobin") %>%
  ggplot(aes(x=diabetesStatus, fill=AbnormalFlagsSorted))+
  geom_bar(position="fill") +
  labs(title = "Hemoglobin Result Status", x = "Diabetes Status", fill = "Result Status", y = "Percent") +
  theme(plot.title = element_text(hjust = 0.5))


patientLabs %>%
  filter(HL7Text == "Hemoglobin") %>%
  ggplot(aes(x=diabetesStatus,y=ObservationValue, fill=AbnormalFlags)) +
  stat_boxplot(geom="boxplot", position="dodge", coef=2, outlier.shape=NA, na.rm=TRUE, show.legend = TRUE) + 
  labs(title = "Hemoglobin Lab Results", x = "Diabetes Status", fill = "Result Status", y = "Hemoglobin (g/dL)") +
  theme(plot.title = element_text(hjust = 0.5))

```

\pagebreak

#### Hematocrit Lab Results
The central tendency of Hematocrit percentage was lower in the diabetic population than in the non-diabetic population. The ratio of above normal readings was lower and of below normal readings was higher among the diabetic population.  The central tendency of above normal readings was higher and of below normal readings was lower in the diabetic population.  The central tendency of normal readings was lower in the diabetic population.

```{r}
boxplot(ObservationValue~diabetesStatus, data=patientLabs %>% filter(HL7Text == "Hematocrit"), outline=FALSE)

patientLabs %>%
  filter(HL7Text == "Hematocrit") %>%
  ggplot(aes(x=diabetesStatus, fill=AbnormalFlagsSorted))+
  geom_bar(position="fill") +
  labs(title = "Hematocrit Result Status", x = "Diabetes Status", fill = "Result Status", y = "Percent") +
  theme(plot.margin = margin(0,0,0,2,"cm"), axis.text.x = element_text(angle = 30, hjust = 1), plot.title = element_text(hjust = 0.5))

patientLabs %>%
  filter(HL7Text == "Hematocrit") %>%
  ggplot(aes(x=diabetesStatus,y=ObservationValue, fill=AbnormalFlags)) +
  stat_boxplot(geom="boxplot", position="dodge", coef=2, outlier.shape=NA, na.rm=TRUE, show.legend = TRUE) + 
  labs(title = "Hematocrit Lab Results", x = "Diabetes Status", fill = "Result Status", y = "Hematocrit Percent") +
  theme(plot.title = element_text(hjust = 0.5))

```

\pagebreak

#### Chloride Lab Results
The Chloride lab results are more spread out for the diabetic population than for the non-diabetic population.  There's a larger ratio of both above and below normal readings in the diabetic population, but the abnormal levels aren't as severe.

```{r}
boxplot(ObservationValue~diabetesStatus, data=patientLabs %>% filter(HL7Text == "Chloride"), outline=FALSE)

patientLabs %>%
  filter(HL7Text == "Chloride") %>%
  ggplot(aes(x=diabetesStatus, fill=AbnormalFlagsSorted))+
  geom_bar(position="fill") +
  labs(title = "Chloride Result Status", x = "Diabetes Status", fill = "Result Status", y = "Percent") +
  theme(plot.margin = margin(0,0,0,2,"cm"), axis.text.x = element_text(angle = 30, hjust = 1), plot.title = element_text(hjust = 0.5))

patientLabs %>%
  filter(HL7Text == "Chloride") %>%
  ggplot(aes(x=diabetesStatus,y=ObservationValue, fill=AbnormalFlags)) +
  stat_boxplot(geom="boxplot", position="dodge", coef=2, outlier.shape=NA, na.rm=TRUE, show.legend = TRUE) + 
  labs(title = "Chloride Lab Results", x = "Diabetes Status", fill = "Result Status", y = "Chloride (mmol/L)") +
  theme(plot.title = element_text(hjust = 0.5))

```

\pagebreak

#### Triglyceride Lab Results
The central tendency of triglyceride levels is higher in the diabetic population than in the non-diabetic population.  There is a higher ratio of above normal triglyceride readings in the diabetic population, and both the above normal and normal triglyceride levels are higher in the diabetic population.

```{r}
boxplot(ObservationValue~diabetesStatus, data=patientLabs %>% filter(HL7Text == "Triglyceride"), outline=FALSE)

patientLabs %>%
  filter(HL7Text == "Triglyceride") %>%
  ggplot(aes(x=diabetesStatus, fill=AbnormalFlagsSorted))+
  geom_bar(position="fill") +
  labs(title = "Triglyceride Result Status", x = "Diabetes Status", fill = "Result Status", y = "Percent") +
  theme(plot.margin = margin(0,0,0,2,"cm"), axis.text.x = element_text(angle = 30, hjust = 1), plot.title = element_text(hjust = 0.5))

patientLabs %>%
  filter(HL7Text == "Triglyceride") %>%
  ggplot(aes(x=diabetesStatus,y=ObservationValue, fill=AbnormalFlags)) +
  stat_boxplot(geom="boxplot", position="dodge", coef=2, outlier.shape=NA, na.rm=TRUE, show.legend = TRUE) + 
  labs(title = "Triglyceride Lab Results", x = "Diabetes Status", fill = "Result Status", y = "Triglyceride (mg/dL)") +
  theme(plot.title = element_text(hjust = 0.5))

```

\pagebreak

#### Platelets Lab Results
The central tendency of Platelet levels is lower in the diabetic population than in the non-diabetic population, particularly in the normal set.  The ratio of both above and below normal readings are greater in the diabetic population, but the abnormal levels aren't as severe.

```{r}
boxplot(ObservationValue~diabetesStatus, data=patientLabs %>% filter(HL7Text == "Platelets"), outline=FALSE)

patientLabs %>%
  filter(HL7Text == "Platelets") %>%
  ggplot(aes(x=diabetesStatus, fill=AbnormalFlagsSorted))+
  geom_bar(position="fill") +
  labs(title = "Platelets Result Status", x = "Diabetes Status", fill = "Result Status", y = "Percent") +
  theme(plot.margin = margin(0,0,0,2,"cm"), axis.text.x = element_text(angle = 30, hjust = 1), plot.title = element_text(hjust = 0.5))

patientLabs %>%
  filter(HL7Text == "Platelets") %>%
  ggplot(aes(x=diabetesStatus,y=ObservationValue, fill=AbnormalFlags)) +
  stat_boxplot(geom="boxplot", position="dodge", coef=2, outlier.shape=NA, na.rm=TRUE, show.legend = TRUE) + 
  labs(title = "Platelets Lab Results", x = "Diabetes Status", fill = "Result Status", y = "Platelets (x10E3/uL)") +
  theme(plot.title = element_text(hjust = 0.5))
```

\pagebreak

### Prescription Data
There are 18 medications with at least 300 prescriptions and at least 60% use by diabetic patients. 

```{r}
topDiabeticPrescriptions %>%
  arrange(desc(useRatio)) %>%
  ggplot(aes(x=MedicationName, fill=factor(diabetesStatus, levels = c("NonDiabetic","Diabetic"))))+
  geom_bar(position="dodge") +
  labs(title = "Top Diabetic Prescriptions", fill = "Diabetes Status") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        plot.margin = margin(0,0,0,7,"cm"),
        plot.title = element_text(hjust = 0.5))
```


```{r}
patientFrame$AllergyType <- as.factor(patientFrame$AllergyType)
patientFrame$age <- as.integer(patientFrame$age)
patientFrame$Gender <- as.factor(patientFrame$Gender)
patientFrame$diagCat <- as.factor(patientFrame$diagCat)
```

```{r}
platelets <- labObservation %>%
  filter(HL7Text == "Platelets") %>%
  select(LabPanelGuid, platelets = ObservationValue)
```

```{r}
hemoglobin <- labObservation %>%
  filter(HL7Text == "Hemoglobin") %>%
  select(LabPanelGuid, hemoglobin = ObservationValue)
```

```{r}
hematocrit <- labObservation %>%
  filter(HL7Text == "Hematocrit") %>%
  select(LabPanelGuid, hematocrit = ObservationValue)
```

```{r}
triglyceride <- labObservation %>%
  filter(HL7Text == "Triglyceride") %>%
  select(LabPanelGuid, triglyceride = ObservationValue)
```

```{r}
labFrame <- full_join(hemoglobin, full_join(triglyceride, full_join(hematocrit, platelets)))
```

```{r}
panels <- right_join(labPanel,labFrame)
```

```{r}
results <- right_join(labResult,panels)
```

```{r}
allergyFrame <- left_join(
  allergy %>% filter(AllergyType != "Medication") %>% select(AllergyGuid,PatientGuid,AllergyType),
  transAllergy
  )
```

```{r}
allergyFrame <- left_join(
  allergyFrame,
  transcript %>% select(TranscriptGuid,PatientGuid)
  )
```



```{r}
patientFrame = NULL
patientFrame <- left_join(
  patient %>% select(PatientGuid, dmIndicator, Gender, YearOfBirth),
  allergyFrame %>% select(PatientGuid, TranscriptGuid, AllergyType)
)
```

```{r}
diagnosisFrame <- diagnosis %>%
  select(DiagnosisGuid, PatientGuid, ICD9Code, diagCat)
```

```{r}
diagnosisFrame <- left_join(
  diagnosisFrame, transDiag
)
```

```{r}
diagnosisFrame <- left_join(
  diagnosisFrame, transcript %>% select(TranscriptGuid, PatientGuid)
)
```

```{r}
diagnosisFrame <- diagnosisFrame %>%
  select(-TranscriptDiagnosisGuid)
```

```{r}
patientFrame2 <- left_join(patientFrame, diagnosisFrame)
```

```{r}
patientFrame3 <- full_join(
  patientFrame2, results
)
```


```{r}
transcriptFrame <- transcript %>%
  select(TranscriptGuid, PatientGuid, BMI, SystolicBP, DiastolicBP)
```

```{r}
# change transcript Height & Weight to numeric types
transcriptFrame <- transform(transcriptFrame, SystolicBP = as.numeric(SystolicBP), DiastolicBP = as.numeric(DiastolicBP))
```

```{r}
# add pulsePressure column to transcript (SystolicBP - DiastolicBP)
transcriptFrame <- transcriptFrame %>%
  filter(BMI > 0 | (!is.na(SystolicBP) & !is.na(DiastolicBP)))
```

  filter(!is.na(SystolicBP)) %>% filter(!is.na(DiastolicBP)) %>% filter(SystolicBP > 0 & DiastolicBP > 0) %>%
  mutate(pulsePressure = SystolicBP - DiastolicBP)

```{r}
transcriptFrame[,4:5][is.na(transcriptFrame[,4:5])] <- 0
```

```{r}
transcriptFrame <- transcriptFrame %>% mutate(pulsePressure = SystolicBP - DiastolicBP)
```

```{r}
transcriptFrame <- transcriptFrame %>%
  select(-SystolicBP, -DiastolicBP) %>%
  filter(BMI > 0 | pulsePressure > 0)
```

```{r}
patientFrame4 <- left_join(patientFrame3,transcriptFrame)
```

```{r}
patientFrame4 <- patientFrame4 %>%
  select(-LabResultGuid,-LabPanelGuid, -PanelName)
```

```{r}
patientFrame4 <- patientFrame4 %>% mutate(age = 2010 - YearOfBirth) %>% select(-YearOfBirth)
```


```{r}
patientFrame4 <- patientFrame4 %>%
  select(-TranscriptGuid, -DiagnosisGuid)
```

```{r}
patientFrame4$Gender <- as.factor(patientFrame4$Gender)
patientFrame4$AllergyType <- as.factor(patientFrame4$AllergyType)
patientFrame4$diagCat <- as.factor(patientFrame4$diagCat)
```

```{r}
library(caTools)
patientSplit = sample.split(patientFrame4$dmIndicator, SplitRatio = 0.7)
patientTrain = subset(patientFrame4, patientSplit == TRUE)
patientTest = subset(patientFrame4, patientSplit == FALSE)
```

```{r}
library(randomForest)
library(caTools)
library(rpart)
library(rpart.plot)
library(ROCR)
library(caret)
library(e1071)
```

```{r}
patientTrain$dmIndicator = as.factor(patientTrain$dmIndicator)
patientTest$dmIndicator = as.factor(patientTest$dmIndicator)
patientFrame4$dmIndicator = as.factor(patientFrame4$dmIndicator)
```

```{r}
patientForest = randomForest(dmIndicator ~ Gender + AllergyType + diagCat + age, data = patientTrain, nodesize=25, ntree=200, na.action = na.include)
```

```{r}
predictForest = predict(patientForest, newdata = patientTest)
```

```{r}
table(patientTest$dmIndicator, predictForest)
```

```{r warning = FALSE, message = FALSE}
# read patient table into data frame.
test_patient <- read_csv("testdb/test_patient.csv") %>%
  select(-PracticeGuid)
# read diagnosis table into data frame.  
test_diagnosis <- read_csv("testdb/test_diagnosis.csv") %>%
  select(DiagnosisGuid, DiagnosisDescription, PatientGuid, ICD9Code, StartYear, StopYear, Acute)
# read allergy table into data frame. Change column name of MedicationNdcCode to AllergyMedicationNdcCode to diambiguate between medication allergies and prescriptions.
test_allergy <- read_csv("testdb/test_allergy.csv") %>%
  select(AllergyGuid, PatientGuid, AllergyType, AllergyStartYear = StartYear, ReactionName, SeverityName, AllergyMedicationNdcCode = MedicationNDCCode)
# read prescription table into data frame.
test_prescription <- read_csv("testdb/test_prescription.csv") %>%
  select(PrescriptionGuid, PatientGuid, MedicationGuid, PrescriptionYear, Quantity, GenericAllowed)
# read medication table into data frame.
test_medication <- read_csv("testdb/test_medication.csv") %>%
  select(MedicationGuid, PatientGuid, MedicationNdcCode, MedicationName, MedicationStrength, Schedule, DiagnosisGuid)
# read lab tables into data frames.
test_labResult <- read_csv("testdb/test_labResult.csv") %>%
  select(LabResultGuid,PatientGuid, TranscriptGuid)

test_labPanel <- read_csv("testdb/test_labPanel.csv") %>%
  select(LabResultGuid, LabPanelGuid, PanelName)

test_labObservation <- read_csv("testdb/test_labObservation.csv")
# read transcript table into data frame.
test_transcript <- read_csv("testdb/test_transcript.csv") %>%
  select(TranscriptGuid, PatientGuid, VisitYear, Height, Weight, BMI, SystolicBP, DiastolicBP, RespiratoryRate, HeartRate, Temperature)
#read join tables into data frames.
test_transDiag <- read_csv("testdb/test_transcriptDiagnosis.csv")
test_transMed <- read_csv("testdb/test_transcriptMedication.csv")
test_transAllergy <- read_csv("testdb/test_transcriptAllergy.csv")

```

```{r warning = FALSE, message = FALSE}
# add age column to patient data frame: derived from subtracting 2010, the median year of the patient data (range: 2009 - 2012)
test_patient <- test_patient %>% mutate(age = 2010 - YearOfBirth)

# change transcript Height & Weight to numeric types
test_transcript <- transform(test_transcript, Height = as.numeric(Height), Weight = as.numeric(Weight), Temperature = as.numeric(Temperature), RespiratoryRate = as.numeric(RespiratoryRate), HeartRate = as.numeric(HeartRate), SystolicBP = as.numeric(SystolicBP), DiastolicBP = as.numeric(DiastolicBP))
  
# add pulsePressure column to transcript (SystolicBP - DiastolicBP)
test_transcript <- test_transcript %>%
  filter(!is.na(SystolicBP)) %>% filter(!is.na(DiastolicBP)) %>% filter(SystolicBP > 0 & DiastolicBP > 0) %>%
  mutate(pulsePressure = SystolicBP - DiastolicBP)
```

```{r warning = FALSE, message = FALSE}
# create diagCat column in test_diagnosis containing iagnosis categories corresponding to ranges of ICD9 Codes
test_diagnosis$diagCat <-
  ifelse((as.integer(test_diagnosis$ICD9Code) < 140), 
    "Infectious/Parasitic",
    ifelse((as.integer(test_diagnosis$ICD9Code) >= 140 &
      as.integer(test_diagnosis$ICD9Code) < 240), 
      "Neoplasms",
      ifelse((as.integer(test_diagnosis$ICD9Code) >=240 &
        as.integer(test_diagnosis$ICD9Code) < 280),
          "Endocrine/Nutritional/Metabolic",
          ifelse((as.integer(test_diagnosis$ICD9Code) >= 280 &
            as.integer(test_diagnosis$ICD9Code) < 290),
            "Blood",
            ifelse((as.integer(test_diagnosis$ICD9Code) >= 290 &
              as.integer(test_diagnosis$ICD9Code) < 320),
              "Mental",
              ifelse((as.integer(test_diagnosis$ICD9Code) >= 320 &
                as.integer(test_diagnosis$ICD9Code) < 390),
                "Nervous",
                ifelse((as.integer(test_diagnosis$ICD9Code) >= 390 &
                  as.integer(test_diagnosis$ICD9Code) < 460),
                  "Circulatory",
                  ifelse((as.integer(test_diagnosis$ICD9Code) >= 460 &
                    as.integer(test_diagnosis$ICD9Code) < 520),
                    "Respiratory",
                    ifelse((as.integer(test_diagnosis$ICD9Code) >= 520 &
                      as.integer(test_diagnosis$ICD9Code) < 580),
                      "Digestive",
  ifelse((as.integer(test_diagnosis$ICD9Code) >= 580 &
    as.integer(test_diagnosis$ICD9Code) < 630), 
    "Genitourinary",
    ifelse((as.integer(test_diagnosis$ICD9Code) >= 630 &
      as.integer(test_diagnosis$ICD9Code) < 680), 
      "Pregnancy",
      ifelse((as.integer(test_diagnosis$ICD9Code) >=680 &
        as.integer(test_diagnosis$ICD9Code) < 710),
          "Skin",
          ifelse((as.integer(test_diagnosis$ICD9Code) >=710 &
            as.integer(test_diagnosis$ICD9Code) < 740),
            "Musculoskeletal",
            ifelse((as.integer(test_diagnosis$ICD9Code) >= 740 &
              as.integer(test_diagnosis$ICD9Code) < 760),
              "Congenital",
              ifelse((as.integer(test_diagnosis$ICD9Code) >= 760 &
                as.integer(test_diagnosis$ICD9Code) < 780),
                "Perinatal",
                ifelse((as.integer(test_diagnosis$ICD9Code) >= 780 &
                  as.integer(test_diagnosis$ICD9Code) < 800),
                  "Ill Defined", 
                  ifelse((as.integer(test_diagnosis$ICD9Code) >= 800),
                    "Injury/Poisoning", 
                    "NULL"
                    )
                  )
                )
            )
          )
      )
    )
  ))))))))))
```

```{r}
# diagnosis data frame
test_diagJoin <- left_join(test_diagnosis, test_transDiag) %>% select(-TranscriptDiagnosisGuid)
test_diagTran <- left_join(test_diagJoin, test_transcript)
# allergy data frame
test_allerJoin <- left_join(test_allergy, test_transAllergy) %>% select(-TranscriptAllergyGuid)
test_allerTran <- left_join(test_allerJoin, test_transcript)
```

```{r}
test_allergyFrame <- left_join(
  test_allergy %>% filter(AllergyType != "Medication") %>% select(AllergyGuid,PatientGuid,AllergyType),
  test_transAllergy
  ) %>% select(-TranscriptAllergyGuid)
```

```{r}
test_allergyFrame <- left_join(
  test_allergyFrame,
  test_transcript %>% select(TranscriptGuid,PatientGuid)
  )
```



```{r}
test_patientFrame = NULL
test_patientFrame <- left_join(
  test_patient %>% select(PatientGuid, Gender, YearOfBirth),
  test_allergyFrame %>% select(PatientGuid, TranscriptGuid, AllergyType)
)
```

```{r}
test_diagnosisFrame <- test_diagnosis %>%
  select(DiagnosisGuid, PatientGuid, ICD9Code, diagCat)
```

```{r}
diagnosisFrame <- left_join(
  diagnosisFrame, transDiag
)
```

```{r}
diagnosisFrame <- left_join(
  diagnosisFrame, transcript %>% select(TranscriptGuid, PatientGuid)
)
```

```{r}
diagnosisFrame <- diagnosisFrame %>%
  select(-TranscriptDiagnosisGuid)
```

```{r}
patientFrame2 <- left_join(patientFrame, diagnosisFrame)
```

```{r}
patientFrame3 <- full_join(
  patientFrame2, results
)
```


```{r}
transcriptFrame <- transcript %>%
  select(TranscriptGuid, PatientGuid, BMI, SystolicBP, DiastolicBP)
```

```{r}
# change transcript Height & Weight to numeric types
transcriptFrame <- transform(transcriptFrame, SystolicBP = as.numeric(SystolicBP), DiastolicBP = as.numeric(DiastolicBP))
```

```{r}
# add pulsePressure column to transcript (SystolicBP - DiastolicBP)
transcriptFrame <- transcriptFrame %>%
  filter(BMI > 0 | (!is.na(SystolicBP) & !is.na(DiastolicBP)))
```

  filter(!is.na(SystolicBP)) %>% filter(!is.na(DiastolicBP)) %>% filter(SystolicBP > 0 & DiastolicBP > 0) %>%
  mutate(pulsePressure = SystolicBP - DiastolicBP)

```{r}
transcriptFrame[,4:5][is.na(transcriptFrame[,4:5])] <- 0
```

```{r}
transcriptFrame <- transcriptFrame %>% mutate(pulsePressure = SystolicBP - DiastolicBP)
```

```{r}
transcriptFrame <- transcriptFrame %>%
  select(-SystolicBP, -DiastolicBP) %>%
  filter(BMI > 0 | pulsePressure > 0)
```

```{r}
patientFrame4 <- left_join(patientFrame3,transcriptFrame)
```

```{r}
patientFrame4 <- patientFrame4 %>%
  select(-LabResultGuid,-LabPanelGuid, -PanelName)
```

```{r}
patientFrame4 <- patientFrame4 %>% mutate(age = 2010 - YearOfBirth) %>% select(-YearOfBirth)
```


```{r}
patientFrame4 <- patientFrame4 %>%
  select(-TranscriptGuid, -DiagnosisGuid)
```

```{r}
patientFrame4$Gender <- as.factor(patientFrame4$Gender)
patientFrame4$AllergyType <- as.factor(patientFrame4$AllergyType)
patientFrame4$diagCat <- as.factor(patientFrame4$diagCat)
```



```{r}
dmIdentify <- left_join(patient,diagnosis)
dmIdentify %>% filter(dmIndicator == 1) %>% group_by(ICD9Code) %>% summarise(n = n()) %>% ungroup() %>% arrange(ICD9Code)
```


