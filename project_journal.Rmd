---
title: "Project Notebook"
author: "Keith Engwall"
date: "1/23/2018"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Project Objectives
Create a predictive model for identifying patients with Diabetes

See [Capstone Proposal](https://github.com/librariandad/introdatascience/blob/master/capstone_proposal.Rmd) for details.

## Project Questions

What is the mean age of diabetic patients?  How does this compare to the general population?

What proportion of diabetic patients are male? female?  How does this compare?


Are there specific allergies that are significantly more or less common among diabetic patients than in the general population?

Are there specific diagnoses significantly more or less common among diabetic patients than in the general population?

Other than medication for diabetes, are there specific medications significantly more or less prescribed to diabetic patients than the general population?

Are there specific abnormal lab readings that occur significantly more or less common among diabetic patients than the general population?

How do standard patient readings (heart rate, blood pressure, temperature, etc.) compare between diabetic patients and the general population?

Is there any correlation between diabetes and smoking?


## Project Dataset
Practice Fusion De-Identified Data Set containing EHR data for approximately 10,000 de-identified patients, including data points for diagnoses, medication, transcript data, and lab observations.  See the [Data Dictionary](https://github.com/librariandad/introdatascience/blob/master/PracticeFusionDataSetDictionary.pdf) for details.


## Project Notes

### Load R Packages
The following packages are needed to work on the project.

Note that dbplyr is required to make database connections using dplyr functions.
```{r}
library(tidyr)
library(dplyr)
library(dbplyr)
library(readr)
```

### Load Data from csv files

Read the data files into R.  Use select statements to pre-filter the desired columns.

```{r message=FALSE, warning=FALSE}

patient <- read_csv("db/training_patient.csv")

diagnosis <- read_csv("db/training_diagnosis.csv") %>%
  select(DiagnosisGuid, PatientGuid, ICD9Code, StartYear, StopYear, Acute)

allergy <- read_csv("db/training_allergy.csv") %>%
  select(AllergyGuid, PatientGuid, AllergyType, AllergyStartYear = StartYear, ReactionName, SeverityName, MedicationNdcCode)

allergy <- transform(allergy, MedicationNdcCode = as.character(MedicationNdcCode))

prescription <- read_csv("db/training_prescription.csv") %>%
  select(PrescriptionGuid, PatientGuid, MedicationGuid, PrescriptionYear, Quantity, GenericAllowed)

medication <- read_csv("db/training_medication.csv") %>%
  select(MedicationGuid, PatientGuid, MedicationNdcCode, MedicationName, MedicationStrength, Schedule, DiagnosisGuid)

immunization <- read_csv("db/training_immunization.csv") %>%
  select(ImmunizationGuid, PatientGuid, VaccineName, AdministeredYear, CvxCode)

labResult <- read_csv("db/training_labResult.csv") %>%
  select(LabResultGuid,PatientGuid, TranscriptGuid)

labPanel <- read_csv("db/training_labPanel.csv") %>%
  select(LabResultGuid, LabPanelGuid, PanelName)

labObservation <- read_csv("db/training_labObservation.csv")


# read in transcript table
transcript <- read_csv("db/training_transcript.csv") %>%
  select(TranscriptGuid, PatientGuid, VisitYear, Height, Weight, BMI, SystolicBP, DiastolicBP, RespiratoryRate, HeartRate, Temperature)

# read in smoke table
smoke <- read_csv("db/training_smoke.csv") %>%
  select(PatientGuid, SmokeEffectiveYear, SmokingStatus_Description, SmokingStatus_NISTCode)

#read in join tables
transDiag <- read_csv("db/training_transcriptDiagnosis.csv")
transMed <- read_csv("db/training_transcriptMedication.csv")
transAllergy <- read_csv("db/training_transcriptAllergy.csv")
```

### create prescription data frame

```{r}
presMed <- left_join(prescription, medication)
presJoin <- left_join(presMed, transMed) %>% select(-TranscriptMedicationGuid)
presTran <- left_join(presJoin, transcript)
patientPrescription <- left_join(patient, presTran)
```

### create diagnosis data frame

```{r}
diagJoin <- left_join(diagnosis, transDiag) %>% select(-TranscriptDiagnosisGuid)
diagTran <- left_join(diagJoin, transcript)
patientDiagnosis <- left_join(patient, diagTran)
```

### create allergy data frame

```{r}
allerJoin <- left_join(allergy, transAllergy) %>% select(-TranscriptAllergyGuid)
allerTran <- left_join(allerJoin, transcript)
patientAllergy <- left_join(patient, allerTran)
```

### create labs data frame

```{r}
# read in lab observations joined to include PatientGuid and PanelName
labs <- left_join(
  left_join(labResult, labPanel, by="LabResultGuid"),
  labObservation,
  by="LabPanelGuid"
)  
patientLabs <- left_join(patient, labs)
```
### create smoking data frame
```{r}
patientSmoke <- left_join(patient, smoke)
```

### create diabetic data frames
```{r}
diabeticPrescription <- patientPrescription %>% filter(dmIndicator == 1)
diabeticDiagnosis <- patientDiagnosis %>% filter(dmIndicator == 1)
diabeticAllergy <- patientAllergy %>% filter(dmIndicator == 1)
diabeticLabs <- patientLabs %>% filter(dmIndicator == 1)
diabeticSmoke <- patientSmoke %>% filter(dmIndicator == 1)
```

## Archived Notes
The following notes represent notes that are no longer relevant to the project, including supplemental information, discarded methods, etc.

### Working with SQLite
The dataset is contained within an SQLite database file (420.7MB).  To load the data into R requires installation and loading of **RSQLite** and **DBI** R packages.  One of the dependencies is the tibble package.  During the install, I was asked whether to install the binary version (1.3.4) or the source version (1.4.1), which would need compilation.  I wasn't comfortable enough to explore compiling R package code yet, so I went with the 1.3.4 version.

I found this brief [example](http://tiffanytimbers.com/querying-sqlite-databases-from-r/) of how to connect to and query an SQLite database file to be very helpful in getting up and going quickly.

```{r eval=FALSE}
#Connect to SQLite file
con <- dbConnect(SQLite(), dbname="data.db")

#Define query and store it in my_query
my_query <- dbSendQuery(con, "SELECT name from person_table")
#Fetch data using query and store it in my_data
my_data <- dbFetch(my_query)

#Clear the results cache from my_query
dbClearResult(my_query)

#Perform additional queries

#Disconnect from the database file
dbDisconnect(con)
```

dplyr also has sqlite functions

### Connect to database
Note that dbplyr library is required in order for this command to work
```{r}
# Connect to database
my_db <- src_sqlite("compData.db")
```

### Load relevant tables
The tables of interest are:

* *training_diagnosis* contains diagnosis information (we need this in order to identify the patients diagnosed with diabetes)
* *training_allergy* contains allergy information for patient
* *training_medication* contains medication information for patient
* *training_patient* contains gender and year of birth
* *training_smoke* combines patient info with smoking statuses
* *lab tables* contain lab results
    + *training_labResult* contains a record of lab results for a particular transcript
    + *training_labPanel* links training_labResult and training_labObservation
    + *training_labObservation* contains details regarding lab tests

```{r}
diagnosis_tbl <- tbl(my_db, sql("SELECT DiagnosisGuid, PatientGuid, ICD9Code, StartYear, StopYear, Acute FROM training_diagnosis"))
```
```{r}
allergy_tbl <- tbl(my_db, sql("SELECT AllergyGuid, PatientGuid, AllergyType, StartYear as AllergyStartYear, ReactionName, SeverityName, MedicationNdcCode FROM training_allergy"))
medication_tbl <- tbl(my_db, sql("SELECT MedicationGuid, PatientGuid, MedicationNdcCode, MedicationName, MedicationStrength, Schedule, DiagnosisGuid FROM training_medication"))
patient_tbl <- tbl(my_db, sql("SELECT PatientGuid, Gender, YearOfBirth FROM training_patient"))
transcript_tbl <- tbl(my_db, sql("SELECT TranscriptGuid, PatientGuid, VisitYear, Height, Weight, BMI, SystolicBP, DiastolicBP, RespiratoryRate, HeartRate, Temperature FROM training_transcript"))
smoke_tbl <- tbl(my_db, sql("SELECT PatientGuid, SmokeEffectiveYear, SmokingStatus_Description, SmokingStatus_NISTCode FROM training_smoke"))
# to get a single table that links the observation data back to the patient,
# join training_labResult, training_labPanel, and training labObservation
lab_tbl <- left_join(left_join(tbl(my_db,sql("SELECT LabResultGuid, PatientGuid FROM training_labResult")),tbl(my_db,sql("SELECT LabResultGuid, LabPanelGuid, PanelName FROM training_labPanel")), by="LabResultGuid"),tbl(my_db,"training_labObservation"), by="LabPanelGuid")
```

### Identify target population  
All Type 1 Diabetes diagnoses have an ICD9Code that starts with 205.  We have a table with all of the diagnoses and one with only the diabetes diagnoses.

```{r}
diabetes_tbl <- tbl(my_db, sql("SELECT DiagnosisGuid, PatientGuid, ICD9Code, StartYear, StopYear, Acute FROM training_diagnosis WHERE ICD9Code LIKE '250%'")) %>% glimpse()
```

### Identify allergy data for target population
```{r warning=FALSE}
# join allergy_tbl to diabetes_tbl to get allergy data for diabetic patients
diabetes_allergy_tbl <- as_tibble(left_join(diabetes_tbl, allergy_tbl, by = c("PatientGuid"))) %>%
  select(PatientGuid, AllergyGuid, AllergyType, ReactionName, SeverityName, AllergyMedicationNdcCode = MedicationNdcCode)

# add has_allergy to diabetes_allergy_tbl to indicate whether diabetic patient has allergies
diabetes_allergy_tbl <- diabetes_allergy_tbl %>%
  mutate(has_allergy = as.integer(!is.na(diabetes_allergy_tbl$AllergyGuid)))

glimpse(diabetes_allergy_tbl)
```

### Identify medication data for target population
Exclude medication specifically given in response to diabetes diagnosis (?)
```{r warning=FALSE}
# join medication_tbl to diabetes_tbl to get medication data for diabetic patients
# filter out medication that is linked to the diabetes diagnosis
diabetes_medication_tbl <- as_tibble(left_join(diabetes_tbl, medication_tbl, by = c("PatientGuid"))) %>% 
  filter(DiagnosisGuid.x != DiagnosisGuid.y) %>% 
  select(PatientGuid, MedicationGuid, MedicationNdcCode)

# add has_meds to diabetes_medication_tbl to indicate whether diabetic patient has medication
diabetes_medication_tbl <- diabetes_medication_tbl %>%
  mutate(has_meds = as.integer(!is.na(diabetes_medication_tbl$MedicationGuid)))

glimpse(diabetes_medication_tbl)

```

### Identify patient information for target population
```{r warning=FALSE}
# join patient_tbl to diabetes_tbl to get gender & age data for diabetic patients
diabetes_patient_tbl <- as_tibble(left_join(diabetes_tbl, patient_tbl, by = c("PatientGuid"))) %>%
  select(PatientGuid, Gender, YearOfBirth) %>% glimpse()
```

### Identify smoking information for target population
Need to parse through results to identify smokers, former smokers, etc.  How should these be grouped?

```{r warning=FALSE}
# join smoke_tbl to diabetes_tbl to get smoking data for diabetic patients
diabetes_smoke_tbl <- as_tibble(left_join(diabetes_tbl, smoke_tbl, by = c("PatientGuid"))) %>%
  select(PatientGuid, SmokeEffectiveYear, SmokingStatus_Description, SmokingStatus_NISTCode) %>%
  arrange(SmokingStatus_NISTCode) %>%
  glimpse()
```

### Identify lab information for target population
```{r warning=FALSE}
# join lab_tbl to diabetes_tbl to get lab results data for diabetic patients
diabetes_lab_tbl <- as_tibble(left_join(diabetes_tbl, lab_tbl, by = c("PatientGuid"))) %>%
  select(PatientGuid, LabObservationGuid, HL7Identifier, HL7Text, HL7CodingSystem, ObservationValue, Units, ReferenceRange, AbnormalFlags, ResultStatus, ObservationYear)

# add has_labs to diabetes_lab_tbl to indicate whether diabetic patient has lab results
diabetes_lab_tbl <- diabetes_lab_tbl %>%
  mutate(has_labs = as.integer(!is.na(diabetes_lab_tbl$LabObservationGuid)))

glimpse(diabetes_lab_tbl)

```

### disconnect from database
This is getting an error.  May have to use a different method to connect
```{r eval=FALSE}
dbDisconnect(my_db)
```


### no longer using the following to create R data structures
join tables that link on transcript
```{r message = FALSE}
#join diagnosis and transcript
diagJoin <- left_join(diagnosis, transDiag) %>% select(-TranscriptDiagnosisGuid)
diagTran <- left_join(diagJoin, transcript)
diagTran$TranscriptGuid[is.na(diagTran$TranscriptGuid)] <- "DIAG"

#join medication and transcript
medJoin <- left_join(medication, transMed) %>% select(-TranscriptMedicationGuid)
medTran <- left_join(medJoin, transcript)
medTran$TranscriptGuid[is.na(medTran$TranscriptGuid)] <- "MED"

# join allergy and transcript
allerJoin <- left_join(allergy,transAllergy) %>% select(-TranscriptAllergyGuid)
allerTran <- left_join(allerJoin, transcript)
allerTran$TranscriptGuid[is.na(allerTran$TranscriptGuid)] <- "ALLERGY"

# join medTran, diagTran, allerTran, and rest of transcript
allerDiagMedTran <- full_join(full_join(full_join(allerTran,diagTran),medTran),transcript)
```

give non-transcript tables TranscriptGuid column so that they join without causing cartesian products
```{r message=FALSE}
smoke <- smoke %>% mutate(TranscriptGuid = "SMOKE")
immunization <- immunization %>% mutate(TranscriptGuid = "IMMUNIZATION")
```

join remaining tables
```{r message=FALSE}
admts <- full_join(allerDiagMedTran, smoke)
admtsi <- full_join(admts, immunization)
admtsil <- full_join(admtsi, labs)
patient_pop_data <- left_join(patient,admtsil)
```
isolate diabetes patients 
```{r}
diabetes_pop_data <- patient_pop_data %>% filter(dmIndicator == 1)

glimpse(patient_pop_data)

glimpse(diabetes_pop_data)
```
